/**
 * @file Firebase Security Rules for the LocalDink application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles,
 * with shared access patterns for game sessions and groups. It prioritizes
 * authorization independence and avoids complex `get()` calls within rules by
 * denormalizing authorization data directly onto secured documents. This approach
 * optimizes performance and simplifies access control logic.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, with the document ID matching the
 *   user's authentication UID. This enforces strict ownership.
 * - /gameSessions/{gameSessionId}: Stores game session data, including a
 *   denormalized `organizerId` field for authorization.
 * - /courts/{courtId}: Stores court data. No specific write restrictions.
 * - /groups/{groupId}: Stores group data, with access controlled by the
 *   `memberIds` array within the document.
 *
 * Key Security Decisions:
 * - User profiles are strictly owned by the authenticated user.
 * - Game session access is controlled by the `organizerId` field.
 * - Group access is controlled by membership in the `memberIds` array.
 * - Listing of user profiles is disabled for all users.
 *
 * Denormalization for Authorization:
 * - Game sessions include an `organizerId` field to allow direct authorization
 *   without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles under /users/{userId}.
     * @path /users/{userId}
     * @allow (get, create, update) User with matching UID can access their profile.
     * @deny (get, create, update) User attempts to access another user's profile.
     * @deny (list) Listing user profiles is not allowed.
     * @principle Enforces document ownership for user profiles based on the user ID in the path.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if false; // User profile deletion is not supported
    }

    /**
     * @description Secure game sessions under /gameSessions/{gameSessionId}.
     * @path /gameSessions/{gameSessionId}
     * @allow (create) User can create a game session if they are the organizer.
     * @allow (get, update, delete) Organizer can read, update, and delete the game session.
     * @deny (create, update, delete) Non-organizers cannot modify game sessions.
     * @deny (list) Anyone can list game sessions
     * @principle Enforces ownership of game sessions based on the organizerId field.
     */
    match /gameSessions/{gameSessionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && isGameSessionOrganizer(resource.data.organizerId) && resource != null;
      allow delete: if isSignedIn() && isGameSessionOrganizer(resource.data.organizerId) && resource != null;
    }

    /**
     * @description Secure courts under /courts/{courtId}.
     * @path /courts/{courtId}
     * @allow (get, list) Anyone can read court information.
     * @allow (create, update, delete) No restrictions on court creation, updates or deletion.
     * @principle Allows public read access to court data.
     */
    match /courts/{courtId} {
      allow get, list: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }

    /**
     * @description Secure groups under /groups/{groupId}.
     * @path /groups/{groupId}
     * @allow (get, list) Anyone can read the group.
     * @allow (create) Anyone can create a group.
     * @allow (update, delete) Only group members can update/delete.
     * @principle Enforces shared access control for groups based on membership.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if true;
      allow update: if isSignedIn() && isGroupMember(resource.data.memberIds);
      allow delete: if isSignedIn() && isGroupMember(resource.data.memberIds) && resource != null;
    }

    // ---- Helper Functions ----

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and it exists.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is the organizer of the game session.
     * @param {string} organizerId The organizer ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the organizer, false otherwise.
     */
    function isGameSessionOrganizer(organizerId) {
      return request.auth.uid == organizerId;
    }

    /**
     * @description Checks if the authenticated user is a member of the group.
     * @param {array} memberIds An array of user IDs that are members of the group.
     * @return {boolean} True if the user is a member, false otherwise.
     */
    function isGroupMember(memberIds) {
      return request.auth.uid in memberIds;
    }
  }
}