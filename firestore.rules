/**
 * @file Firestore Security Rules for LocalDink - Prototyping Mode
 *
 * @Core Philosophy: This ruleset enforces a strict user-ownership model for user profiles
 * and uses denormalized data for authorization of game sessions and groups. This approach
 * prioritizes security and performance by avoiding costly `get()` calls within the rules.
 *
 * @Data Structure:
 * - User profiles are nested under `/users/{userId}`, where `{userId}` matches the Firebase auth UID.
 * - Game sessions are stored in `/gameSessions/{gameSessionId}` and include an `organizerId` field.
 * - Courts are stored in `/courts/{courtId}`.
 * - Groups are stored in `/groups/{groupId}` and include a `memberIds` array.
 *
 * @Key Security Decisions:
 * - User listing is disallowed for the `/users` collection to protect user privacy.
 * - Read access to `/courts` is public.
 * - Write access to `/gameSessions` is restricted to the organizer.
 * - Access to `/groups` is restricted to members.
 *
 * @Denormalization for Authorization:
 * - GameSession documents include the `organizerId` to allow authorization checks without additional reads.
 * - Group documents include the `memberIds` array for authorization checks without additional reads.
 *
 * @Structural Segregation:
 * - Public and private data are separated. User profiles are stored under `/users/{userId}` for private access,
 *   while courts are stored in the top-level `/courts` collection for public read access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces strict user-ownership for user profiles. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create a profile document with the ID 'user_abc'.
     * @allow (get, update, delete) - Authenticated user with UID 'user_abc' can read, update, or delete their own profile document at /users/user_abc.
     * @deny (create, get, update, delete) - Authenticated user with UID 'user_def' cannot access the profile document at /users/user_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the authenticated user is the owner
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the authenticated user is the existing owner
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all user profiles.

      // Allow the user to create their own profile, enforcing that the document ID matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.id == userId;

      // Allow the user to update their own profile, but prevent them from changing the ID.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;

      // Allow the user to delete their own profile.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to game sessions. Only the organizer can create, update, or delete a game session.
     * @path /gameSessions/{gameSessionId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create a game session with organizerId 'user_abc'.
     * @allow (get, list) - Any user can retrieve or list game sessions.
     * @allow (update, delete) - Authenticated user with UID 'user_abc' can update or delete a game session where organizerId is 'user_abc'.
     * @deny (create) - Authenticated user with UID 'user_def' cannot create a game session with organizerId 'user_abc'.
     * @deny (update, delete) - Authenticated user with UID 'user_def' cannot update or delete a game session where organizerId is 'user_abc'.
     * @principle Enforces organizer-only write access with public read access.
     */
    match /gameSessions/{gameSessionId} {
      // Helper function to check if the authenticated user is the organizer
      function isOrganizer(organizerId) {
        return request.auth != null && request.auth.uid == organizerId;
      }

      // Helper function to check if the authenticated user is the existing organizer
      function isExistingOrganizer(organizerId) {
        return isOrganizer(organizerId) && resource != null;
      }

      // Allow anyone to read (get) and list game sessions
      allow get, list: if true;

      // Only allow the organizer to create a game session, validating that the organizerId matches their auth UID.
      allow create: if isOrganizer(request.resource.data.organizerId);

      // Only allow the organizer to update a game session, and only if the document exists
      allow update: if isExistingOrganizer(resource.data.organizerId);

      // Only allow the organizer to delete a game session, and only if the document exists
      allow delete: if isExistingOrganizer(resource.data.organizerId);
    }

    /**
     * @description Allows public read access to courts, with no write access.
     * @path /courts/{courtId}
     * @allow (get, list) - Any user can retrieve or list courts.
     * @deny (create, update, delete) - No user can create, update, or delete courts.
     * @principle Provides public read access with no modification allowed.
     */
    match /courts/{courtId} {
      // Allow anyone to read (get) and list courts
      allow get, list: if true;

      // No one can create, update, or delete courts
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to groups based on membership. Only members can read and write to a group.
     * @path /groups/{groupId}
     * @allow (get, list) - Authenticated user with UID 'user_abc' can retrieve or list groups if they are a member (their UID is in the memberIds array).
     * @allow (create, update, delete) - Authenticated user with UID 'user_abc' can create, update, or delete a group if they are a member.
     * @deny (get, list, create, update, delete) - Authenticated user with UID 'user_def' cannot access the group if they are not a member.
     * @principle Enforces membership-based access control.
     */
    match /groups/{groupId} {
      // Helper function to check if the authenticated user is a member of the group
      function isMember() {
        return request.auth != null && request.auth.uid in resource.data.memberIds;
      }

      // Helper function to check if the authenticated user is a member of the group for a create operation
      function isNewMember() {
        return request.auth != null && request.auth.uid in request.resource.data.memberIds;
      }

      // Helper function to check if the authenticated user is an existing member of the group
      function isExistingMember() {
        return isMember() && resource != null;
      }

      // Allow members to read (get) and list groups
      allow get, list: if isMember();

      // Allow members to create groups if they add themselves as a member.
      allow create: if isNewMember();

      // Only allow members to update the group
      allow update: if isExistingMember();

      // Only allow members to delete the group
      allow delete: if isExistingMember();
    }
  }
}