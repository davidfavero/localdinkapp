/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for user profiles
 * and a role-based model for game sessions, courts, and groups.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, owned by the user with matching UID.
 * - /gameSessions/{gameSessionId}: Game sessions, accessible based on organizerId.
 * - /courts/{courtId}: Courts, publicly readable.
 * - /groups/{groupId}: Groups, accessible to members.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile.
 * - Game session access is controlled by the organizer.
 * - Courts are publicly readable, but write access is restricted to the organizer.
 * - Group access is limited to group members.
 * - Listing of the `users` collection is disallowed to prevent information disclosure.
 *
 * Denormalization for Authorization:
 * - GameSession documents include an `organizerId` field to avoid needing to `get()` the organizer's UserProfile for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (get, create, update, delete) User with matching UID can access their own profile.
     * @deny (get, create, update, delete) User tries to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get, create, update, delete: if isSignedIn() && isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Controls access to game sessions.
     * @path /gameSessions/{gameSessionId}
     * @allow (get, list) Any signed-in user can read game session details.
     * @allow (create) User can create a game session if they are the organizer.
     * @allow (update, delete) Only the organizer can update or delete a game session, after verifying that the document exists.
     * @deny (create, update, delete) Non-organizer tries to create, update, or delete a game session.
     * @principle Enforces organizer-based access control for writes.
     */
    match /gameSessions/{gameSessionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.organizerId);
    }

    /**
     * @description Controls access to courts.
     * @path /courts/{courtId}
     * @allow (get, list) Any user can read court information.
     * @deny (create, update, delete) No one can create, update or delete courts.
     * @principle Public read access, no write access.
     */
    match /courts/{courtId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to groups.
     * @path /groups/{groupId}
     * @allow (get, list) Any signed-in user can read group information.
     * @allow (create) Any signed-in user can create a group.
     * @allow (update, delete) Not allowed
     */
    match /groups/{groupId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
    }
  }
}