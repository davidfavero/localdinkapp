/**
 * @fileOverview Firestore Security Rules for the LocalDink application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles,
 * organizer-based authorization for game sessions, and shared access for groups.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, owned by the user with matching UID.
 * - /gameSessions/{gameSessionId}: Game sessions, access controlled by the organizer.
 * - /courts/{courtId}: Publicly readable court information.
 * - /groups/{groupId}: Groups of players, access controlled by group membership.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Game sessions can only be created, updated, or deleted by the organizer.
 * - Courts are publicly readable.
 * - Groups are accessible to their members.
 * - Data validation is limited to authorization-critical fields for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - Game sessions denormalize the organizerId to enable authorization without extra reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates their profile at /users/user123.
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes their profile at /users/user123.
     * @deny (create) User with UID 'user456' tries to create a profile at /users/user123.
     * @deny (get, update, delete) User with UID 'user456' tries to read/update/delete the profile at /users/user123.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      // Verified user identity
      allow get: if isOwner(userId);
      allow list: if false;

      // Only the user can create their own profile.  The ID in the document must match the authenticated user's ID.
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Only the owner can update or delete their profile.
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to game session data.
     * @path /gameSessions/{gameSessionId}
     * @allow (create) User with UID 'user123' creates a game session with organizerId 'user123'.
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes a game session where they are the organizer.
     * @deny (create) User with UID 'user456' creates a game session with organizerId 'user123'.
     * @deny (update, delete) User with UID 'user456' tries to update/delete a game session where 'user123' is the organizer.
     * @principle Enforces organizer-based authorization for game sessions.
     */
    match /gameSessions/{gameSessionId} {
      allow get, list: if true; // Public read access for game sessions.

      // Only the organizer can create a game session, and the organizerId must match the authenticated user's ID.
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;

      // Only the organizer can update or delete the game session
      allow update: if isSignedIn() && get(resource).data.organizerId == request.auth.uid;
      allow delete: if isSignedIn() && get(resource).data.organizerId == request.auth.uid;
    }

    /**
     * @description Controls access to court data.
     * @path /courts/{courtId}
     * @allow (get, list) Any user can read court data.
     * @deny (create, update, delete) No user can create, update, or delete court data.
     * @principle Allows public read access but restricts write access.
     */
    match /courts/{courtId} {
      allow get, list: if true; // Public read access for court data.
      allow create, update, delete: if false; // No write access.
    }

    /**
     * @description Controls access to group data based on group membership.
     * @path /groups/{groupId}
     * @allow (get, list) Any member can read groups
     * @allow (create) A user that creates a group becomes a member
     * @allow (update, delete) Only members can modify group details, or delete a group
     * @principle Enforces group membership for access control.
     */
    match /groups/{groupId} {
      allow get, list: if isSignedIn() && isGroupMember(groupId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isGroupMember(groupId);
      allow delete: if isSignedIn() && isGroupMember(groupId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isGroupMember(groupId) {
    return exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
  }
}