rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if the request is made by the user with matching userId.
     * @deny (list) prevents listing all user documents.
     * @deny (get, create, update, delete) if the request is not made by the user with matching userId.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to game session documents.
     * @path /gameSessions/{gameSessionId}
     * @allow (get, list) if true
     * @allow (create) if the request is made by the user with matching organizerId.
     * @allow (update, delete) if the request is made by the user with matching organizerId and the document exists.
     * @deny (create, update, delete) if the request is not made by the user with matching organizerId.
     * @principle Enforces organizer-only access for writes.
     */
    match /gameSessions/{gameSessionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.organizerId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.organizerId && exists(/databases/$(database)/documents/gameSessions/$(gameSessionId));
      allow delete: if isSignedIn() && request.auth.uid == resource.data.organizerId && exists(/databases/$(database)/documents/gameSessions/$(gameSessionId));
    }

    /**
     * @description Controls access to court documents.
     * @path /courts/{courtId}
     * @allow (get, list) allow public read access to court documents.
     * @deny (create, update, delete) never allow client-side creation, updates, or deletion of court documents.
     * @principle Courts are considered public read-only data.
     */
    match /courts/{courtId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to group documents.
     * @path /groups/{groupId}
     * @allow (get, list) if the user is a member of the group.
     * @allow (create, update, delete) if the user is a member of the group and the document exists.
     * @deny (get, list) if the user is not a member of the group.
     * @principle Enforces member-only access for groups.
     */
    match /groups/{groupId} {
      allow get: if isSignedIn() && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds;
      allow list: if isSignedIn() && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds;
      allow create: if isSignedIn() && request.resource.data.memberIds is list && request.auth.uid in request.resource.data.memberIds;
      allow update: if isSignedIn() && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds && exists(/databases/$(database)/documents/groups/$(groupId));
      allow delete: if isSignedIn() && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds && exists(/databases/$(database)/documents/groups/$(groupId));
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}