/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and a shared-access model for game sessions and groups. It prioritizes authorization independence through data denormalization and aims for secure list operations.
 * @dataStructure
 *  - /users/{userId}: Stores user profiles, with access restricted to the user themselves.
 *  - /gameSessions/{gameSessionId}: Stores game sessions, with access controlled by the organizerId field.
 *  - /courts/{courtId}: Stores court information, publicly readable.
 *  - /groups/{groupId}: Stores group information, with access controlled by group membership.
 * @keySecurityDecisions
 *  - Listing of users is explicitly disallowed to protect user privacy.
 *  - Game session access is based on the denormalized `organizerId` field for efficiency.
 *  - Courts are publicly readable to allow easy discovery.
 *  - All writes are protected by authorization checks, never `if true`.
 * @denormalizationForAuthorization
 *  - Game sessions denormalize the `organizerId` to enable authorization without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents, ensuring only the authenticated user can read or modify their own profile.
     * @path /users/{userId}
     * @allow (get, create, update) if request.auth != null && request.auth.uid == userId; User with UID 'user123' can read/write their own profile at /users/user123.
     * @deny (get, create, update) if request.auth == null; Anonymous user cannot access any user profile.
     * @deny (get, create, update) if request.auth.uid != userId; User with UID 'user123' cannot access profile at /users/user456.
     * @deny list if true; Listing all users is not permitted.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      allow get, create, update: if isSignedIn() && isOwner(userId);
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Controls access to game session documents, allowing the organizer to read, update, and delete.
     * @path /gameSessions/{gameSessionId}
     * @allow (get, create) if request.auth != null && request.auth.uid == request.resource.data.organizerId; User with UID 'user123' can create a game session with organizerId 'user123'.
     * @allow (update, delete) if request.auth != null && resource.data.organizerId == request.auth.uid; User with UID 'user123' can update/delete a game session where they are the organizer.
     * @allow list: if true; Anyone can list the available game sessions.
     * @deny (create) if request.auth == null; Anonymous user cannot create a game session.
     * @deny (create) if request.auth.uid != request.resource.data.organizerId; User with UID 'user123' cannot create a game session with organizerId 'user456'.
     * @deny (update, delete) if request.auth.uid != resource.data.organizerId; User with UID 'user123' cannot update/delete a game session organized by 'user456'.
     * @principle Enforces ownership based on the denormalized `organizerId` field.
     */
    match /gameSessions/{gameSessionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.data.organizerId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.organizerId;
    }

    /**
     * @description Controls access to court documents, allowing anyone to read court information but restricting creation, updating, and deletion.
     * @path /courts/{courtId}
     * @allow get, list: if true; Anyone can read/list court information.
     * @deny create, update, delete: if true; Only administrators should create, update, or delete court information.
     * @principle Allows public read access while restricting write access.
     */
    match /courts/{courtId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to group documents, allowing members to read group information and restricting creation, updating, and deletion.
     * @path /groups/{groupId}
     * @allow get, list: if true; // Anyone can read the group information
     * @allow create: if isSignedIn(); // Any signed in user can create a new group
     * @allow update, delete: if false; // Group editing and deleting is not possible
     * @principle Allows public read access while restricting write access.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

}